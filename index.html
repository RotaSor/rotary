<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ROTASOR</title>

  <style>
    body {
      margin: 0; padding: 0;
      font-family: Arial;
      background: url('arkaplan.jpg') no-repeat center/cover fixed;
      display: flex; justify-content: center; align-items: center;
      height: 100vh;
    }
    .container {
      background: rgba(255,255,255,0.9);
      padding: 30px; border-radius: 20px;
      text-align: center; width: 300px;
    }
    input, button { width: 90%; padding: 10px; margin: 8px 0; }
    button {
      background: #001f3f; color: white; border: none; border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background:#003366; }
    .hidden { display:none; }
    .error { color:red; font-size:14px; }
  </style>
</head>

<body>

  <div class="container" id="welcome-screen">
    <img src="logo.png" class="logo" style="width:100px;">
    <h1>ROTASOR</h1>
    <button onclick="showMenu()">ÖĞRENCİ</button>
  </div>

  <div class="container hidden" id="menu-screen">
    <h1>ROTASOR</h1>
    <button onclick="showRegister()">Kaydol</button>
    <button onclick="showLogin()">Giriş Yap</button>
  </div>

  <!-- KAYIT -->
  <div class="container hidden" id="register-screen">
    <h2>Kayıt Ol</h2>
    <input type="text" id="class" placeholder="Sınıf (örn: 10)">
    <input type="text" id="section" placeholder="Şube (örn: A)">
    <input type="email" id="email" placeholder="E-posta">
    <input type="text" id="username" placeholder="Kullanıcı Adı">
    <input type="password" id="password" placeholder="Şifre">
    <input type="password" id="confirm-password" placeholder="Şifre (Tekrar)">
    <p class="error" id="register-error"></p>
    <button onclick="register()">Kaydol</button>
    <button onclick="backToMenu()">Geri</button>
  </div>

  <!-- GİRİŞ -->
  <div class="container hidden" id="login-screen">
    <h2>Giriş Yap</h2>
    <input type="text" id="login-class" placeholder="Sınıf">
    <input type="text" id="login-section" placeholder="Şube">
    <input type="text" id="login-username" placeholder="Kullanıcı Adı">
    <input type="password" id="login-password" placeholder="Şifre">
    <p class="error" id="login-error"></p>
    <button onclick="login()">Giriş Yap</button>
    <button onclick="backToMenu()">Geri</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, query, where, collection, getDocs
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzoeVskd64F14c1apRIvF6qqEMhkg7slo",
      authDomain: "rotasor.firebaseapp.com",
      projectId: "rotasor",
      storageBucket: "rotasor.firebasestorage.app",
      messagingSenderId: "869549028260",
      appId: "1:869549028260:web:ce7d16c91a9755019bc731"
    };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- DOM referanslarını al (hepsini getElementById ile) ---
  const welcomeScreen = document.getElementById("welcome-screen");
  const menuScreen = document.getElementById("menu-screen");
  const registerScreen = document.getElementById("register-screen");
  const loginScreen = document.getElementById("login-screen");

  // Register inputs
  const inpClass = document.getElementById("class");               // id="class"
  const inpSection = document.getElementById("section");         // id="section"
  const inpEmail = document.getElementById("email");             // id="email"
  const inpUsername = document.getElementById("username");       // id="username"
  const inpPassword = document.getElementById("password");       // id="password"
  const inpConfirm = document.getElementById("confirm-password");// id="confirm-password"
  const registerError = document.getElementById("register-error");

  // Login inputs
  const inpLoginClass = document.getElementById("login-class");
  const inpLoginSection = document.getElementById("login-section");
  const inpLoginUsername = document.getElementById("login-username");
  const inpLoginPassword = document.getElementById("login-password");
  const loginError = document.getElementById("login-error");

  // --- EKRAN GEÇİŞLERİ ---
  window.showMenu = function() {
    welcomeScreen.classList.add("hidden");
    menuScreen.classList.remove("hidden");
  };
  window.showRegister = function() {
    menuScreen.classList.add("hidden");
    registerScreen.classList.remove("hidden");
  };
  window.showLogin = function() {
    menuScreen.classList.add("hidden");
    loginScreen.classList.remove("hidden");
  };
  window.backToMenu = function() {
    registerScreen.classList.add("hidden");
    loginScreen.classList.add("hidden");
    menuScreen.classList.remove("hidden");
  };

  // --- KAYIT ---
  window.register = async function() {
    const className = inpClass.value.trim();
    const sectionValue = inpSection.value.trim();
    const emailValue = inpEmail.value.trim();
    const usernameValue = inpUsername.value.trim();
    const passwordValue = inpPassword.value;
    const confirmValue = inpConfirm.value;

    registerError.textContent = "";

    if (!className || !sectionValue || !emailValue || !usernameValue || !passwordValue) {
      registerError.textContent = "Lütfen tüm alanları doldurun.";
      return;
    }

    if (passwordValue !== confirmValue) {
      registerError.textContent = "Şifreler eşleşmiyor!";
      return;
    }

    // Kullanıcı adı benzersiz mi?
    try {
      const q = query(collection(db, "users"), where("username", "==", usernameValue));
      const snap = await getDocs(q);
      if (!snap.empty) {
        registerError.textContent = "Bu kullanıcı adı zaten var!";
        return;
      }

      // Auth hesabını oluştur
      const userCred = await createUserWithEmailAndPassword(auth, emailValue, passwordValue);
      const uid = userCred.user.uid;

      // Firestore'a profil bilgisi ekle
      await setDoc(doc(db, "users", uid), {
        uid,
        username: usernameValue,
        email: emailValue,
        className,
        section: sectionValue
      });

      alert("Kayıt başarılı!");
      // temizle (opsiyonel)
      inpClass.value = inpSection.value = inpEmail.value = inpUsername.value = inpPassword.value = inpConfirm.value = "";
      backToMenu();

    } catch (err) {
      registerError.textContent = "Hata: " + err.message;
    }
  };

  // --- GİRİŞ ---
  window.login = async function() {
    const className = inpLoginClass.value.trim();
    const sectionValue = inpLoginSection.value.trim();
    const usernameValue = inpLoginUsername.value.trim();
    const passwordValue = inpLoginPassword.value;

    loginError.textContent = "";

    if (!className || !sectionValue || !usernameValue || !passwordValue) {
      loginError.textContent = "Lütfen tüm alanları doldurun.";
      return;
    }

    try {
      // Kullanıcı adı + sınıf + şube eşleşen belgeyi bul
      const q = query(
        collection(db, "users"),
        where("username", "==", usernameValue),
        where("className", "==", className),
        where("section", "==", sectionValue)
      );

      const snap = await getDocs(q);

      if (snap.empty) {
        loginError.textContent = "Bilgiler hatalı!";
        return;
      }

      const userData = snap.docs[0].data();
      const email = userData.email;

      await signInWithEmailAndPassword(auth, email, passwordValue);

      // Bilgileri localStorage'a yaz
      localStorage.setItem("username", userData.username);
      localStorage.setItem("classSection", `${userData.className}/${userData.section}`);

      window.location.href = "home.html";

    } catch (err) {
      loginError.textContent = "Hata: " + err.message;
    }
  };
</script>

</body>
</html>
